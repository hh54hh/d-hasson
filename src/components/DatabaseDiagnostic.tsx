import React, { useState, useEffect } from "react";
import { Button } from "@/components/ui/button";
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Alert, AlertDescription } from "@/components/ui/alert";
import {
  CheckCircle,
  XCircle,
  AlertTriangle,
  Database,
  RefreshCw,
  Copy,
  ExternalLink,
} from "lucide-react";
import { supabase, isSupabaseConfigured } from "@/lib/supabase";

interface DiagnosticResult {
  name: string;
  status: "success" | "error" | "warning";
  message: string;
  details?: string;
}

const DatabaseDiagnostic: React.FC = () => {
  const [results, setResults] = useState<DiagnosticResult[]>([]);
  const [loading, setLoading] = useState(false);
  const [overallStatus, setOverallStatus] = useState<
    "healthy" | "issues" | "critical"
  >("healthy");

  const runDiagnostic = async () => {
    setLoading(true);
    const diagnosticResults: DiagnosticResult[] = [];

    try {
      // 1. ŸÅÿ≠ÿµ ÿ™ŸÉŸàŸäŸÜ Supabase
      if (!isSupabaseConfigured) {
        diagnosticResults.push({
          name: "ÿ™ŸÉŸàŸäŸÜ Supabase",
          status: "error",
          message: "ÿ•ÿπÿØÿßÿØÿßÿ™ Supabase ŸÖŸÅŸÇŸàÿØÿ©",
          details: "Ÿäÿ¨ÿ® ÿ•ÿ∂ÿßŸÅÿ© VITE_SUPABASE_URL Ÿà VITE_SUPABASE_ANON_KEY",
        });
        setResults(diagnosticResults);
        setOverallStatus("critical");
        setLoading(false);
        return;
      }

      diagnosticResults.push({
        name: "ÿ™ŸÉŸàŸäŸÜ Supabase",
        status: "success",
        message: "ÿ•ÿπÿØÿßÿØÿßÿ™ Supabase ŸÖŸàÿ¨ŸàÿØÿ©",
      });

      // 2. ŸÅÿ≠ÿµ ÿßŸÑÿßÿ™ÿµÿßŸÑ
      try {
        const { error: connectionError } = await supabase!
          .from("customers")
          .select("count")
          .limit(0);

        if (connectionError) {
          diagnosticResults.push({
            name: "ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ŸÄ Supabase",
            status: "error",
            message: "ŸÅÿ¥ŸÑ ÿßŸÑÿßÿ™ÿµÿßŸÑ",
            details: connectionError.message,
          });
        } else {
          diagnosticResults.push({
            name: "ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ŸÄ Supabase",
            status: "success",
            message: "ÿßŸÑÿßÿ™ÿµÿßŸÑ ŸäÿπŸÖŸÑ ÿ®ÿ¥ŸÉŸÑ ÿµÿ≠Ÿäÿ≠",
          });
        }
      } catch (error: any) {
        diagnosticResults.push({
          name: "ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ŸÄ Supabase",
          status: "error",
          message: "ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ¥ÿ®ŸÉÿ©",
          details: error.message,
        });
      }

      // 3. ŸÅÿ≠ÿµ Ÿàÿ¨ŸàÿØ ÿ¨ÿØŸàŸÑ sale_items (ÿßŸÑÿ≥ÿ®ÿ® ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä ŸÑŸÑŸÖÿ¥ŸÉŸÑÿ©)
      try {
        const { error: saleItemsError } = await supabase!
          .from("sale_items")
          .select("id")
          .limit(1);

        if (saleItemsError) {
          if (saleItemsError.code === "42P01") {
            diagnosticResults.push({
              name: "ÿ¨ÿØŸàŸÑ sale_items",
              status: "error",
              message: "üö® ÿ¨ÿØŸàŸÑ sale_items ŸÖŸÅŸÇŸàÿØ - Ÿáÿ∞ÿß ÿ≥ÿ®ÿ® ÿßŸÑŸÖÿ¥ŸÉŸÑÿ©!",
              details: "Ÿáÿ∞ÿß ÿßŸÑÿ¨ÿØŸàŸÑ ŸÖÿ∑ŸÑŸàÿ® ŸÑÿ≠ŸÅÿ∏ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÅŸä ŸÉŸÑ ÿπŸÖŸÑŸäÿ© ÿ®Ÿäÿπ",
            });
          } else {
            diagnosticResults.push({
              name: "ÿ¨ÿØŸàŸÑ sale_items",
              status: "error",
              message: "ŸÖÿ¥ŸÉŸÑÿ© ŸÅŸä ÿ¨ÿØŸàŸÑ sale_items",
              details: saleItemsError.message,
            });
          }
        } else {
          diagnosticResults.push({
            name: "ÿ¨ÿØŸàŸÑ sale_items",
            status: "success",
            message: "ÿ¨ÿØŸàŸÑ sale_items ŸÖŸàÿ¨ŸàÿØ",
          });
        }
      } catch (error: any) {
        diagnosticResults.push({
          name: "ÿ¨ÿØŸàŸÑ sale_items",
          status: "error",
          message: "ŸÅÿ¥ŸÑ ŸÅÿ≠ÿµ ÿ¨ÿØŸàŸÑ sale_items",
          details: error.message,
        });
      }

      // 4. ŸÅÿ≠ÿµ ÿßŸÑÿπŸÑÿßŸÇÿßÿ™ ÿ®ŸäŸÜ ÿßŸÑÿ¨ÿØÿßŸàŸÑ
      try {
        const { error: relationError } = await supabase!
          .from("sales")
          .select("id, sale_items(id)")
          .limit(1);

        if (relationError) {
          if (relationError.code === "PGRST200") {
            diagnosticResults.push({
              name: "ÿπŸÑÿßŸÇÿßÿ™ ÿßŸÑÿ¨ÿØÿßŸàŸÑ",
              status: "error",
              message: "ÿßŸÑÿπŸÑÿßŸÇÿ© ÿ®ŸäŸÜ sales Ÿà sale_items ŸÖŸÅŸÇŸàÿØÿ©",
              details: "Ÿäÿ¨ÿ® ÿ±ÿ®ÿ∑ ÿßŸÑÿ¨ÿØÿßŸàŸÑ ÿ®ŸÄ Foreign Keys",
            });
          } else {
            diagnosticResults.push({
              name: "ÿπŸÑÿßŸÇÿßÿ™ ÿßŸÑÿ¨ÿØÿßŸàŸÑ",
              status: "warning",
              message: "ŸÖÿ¥ŸÉŸÑÿ© ŸÅŸä ÿßŸÑÿπŸÑÿßŸÇÿßÿ™",
              details: relationError.message,
            });
          }
        } else {
          diagnosticResults.push({
            name: "ÿπŸÑÿßŸÇÿßÿ™ ÿßŸÑÿ¨ÿØÿßŸàŸÑ",
            status: "success",
            message: "ÿßŸÑÿπŸÑÿßŸÇÿßÿ™ ÿ™ÿπŸÖŸÑ ÿ®ÿ¥ŸÉŸÑ ÿµÿ≠Ÿäÿ≠",
          });
        }
      } catch (error: any) {
        diagnosticResults.push({
          name: "ÿπŸÑÿßŸÇÿßÿ™ ÿßŸÑÿ¨ÿØÿßŸàŸÑ",
          status: "warning",
          message: "ŸÅÿ¥ŸÑ ŸÅÿ≠ÿµ ÿßŸÑÿπŸÑÿßŸÇÿßÿ™",
          details: error.message,
        });
      }

      // 5. ŸÅÿ≠ÿµ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿπŸäŸÜÿ©
      try {
        const { data: salesData, error: salesError } = await supabase!
          .from("sales")
          .select("id")
          .limit(5);

        if (salesError) {
          diagnosticResults.push({
            name: "ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™",
            status: "error",
            message: "ŸÅÿ¥ŸÑ ŸÅŸä ÿ¨ŸÑÿ® ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™",
            details: salesError.message,
          });
        } else {
          const salesCount = salesData?.length || 0;
          if (salesCount === 0) {
            diagnosticResults.push({
              name: "ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™",
              status: "warning",
              message: "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ®Ÿäÿπÿßÿ™ ŸÖÿ≥ÿ¨ŸÑÿ©",
              details: "ŸäŸÖŸÉŸÜŸÉ ÿ•ÿ∂ÿßŸÅÿ© ÿπŸÖŸÑŸäÿ© ÿ®Ÿäÿπ ŸÑÿßÿÆÿ™ÿ®ÿßÿ± ÿßŸÑŸÜÿ∏ÿßŸÖ",
            });
          } else {
            // ŸÅÿ≠ÿµ ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™ ŸÑŸáÿß ÿ™ŸÅÿßÿµŸäŸÑ ŸÖŸÜÿ™ÿ¨ÿßÿ™
            const { data: itemsData } = await supabase!
              .from("sale_items")
              .select("id")
              .limit(5);

            const itemsCount = itemsData?.length || 0;
            if (itemsCount === 0) {
              diagnosticResults.push({
                name: "ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™",
                status: "error",
                message: `ŸäŸàÿ¨ÿØ ${salesCount} ŸÖÿ®Ÿäÿπÿßÿ™ ŸÑŸÉŸÜ ÿ®ÿØŸàŸÜ ÿ™ŸÅÿßÿµŸäŸÑ ŸÖŸÜÿ™ÿ¨ÿßÿ™`,
                details: "Ÿáÿ∞ÿß ÿ≥ÿ®ÿ® ÿπÿØŸÖ ÿ∏ŸáŸàÿ± ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÅŸä ŸÉÿ¥ŸÅ ÿßŸÑÿ≠ÿ≥ÿßÿ®",
              });
            } else {
              diagnosticResults.push({
                name: "ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™",
                status: "success",
                message: `ŸäŸàÿ¨ÿØ ${salesCount} ŸÖÿ®Ÿäÿπÿßÿ™ ŸÖÿπ ${itemsCount} ŸÖŸÜÿ™ÿ¨`,
              });
            }
          }
        }
      } catch (error: any) {
        diagnosticResults.push({
          name: "ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™",
          status: "warning",
          message: "ŸÅÿ¥ŸÑ ŸÅÿ≠ÿµ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™",
          details: error.message,
        });
      }

      // ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑÿ≠ÿßŸÑÿ© ÿßŸÑÿπÿßŸÖÿ©
      const hasErrors = diagnosticResults.some((r) => r.status === "error");
      const hasWarnings = diagnosticResults.some((r) => r.status === "warning");

      if (hasErrors) {
        setOverallStatus("critical");
      } else if (hasWarnings) {
        setOverallStatus("issues");
      } else {
        setOverallStatus("healthy");
      }

      setResults(diagnosticResults);
    } catch (error: any) {
      diagnosticResults.push({
        name: "ŸÅÿ≠ÿµ ÿπÿßŸÖ",
        status: "error",
        message: "ŸÅÿ¥ŸÑ ÿßŸÑÿ™ÿ¥ÿÆŸäÿµ ÿßŸÑÿπÿßŸÖ",
        details: error.message,
      });
      setResults(diagnosticResults);
      setOverallStatus("critical");
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    runDiagnostic();
  }, []);

  const getStatusIcon = (status: string) => {
    switch (status) {
      case "success":
        return <CheckCircle className="h-4 w-4 text-green-600" />;
      case "error":
        return <XCircle className="h-4 w-4 text-red-600" />;
      case "warning":
        return <AlertTriangle className="h-4 w-4 text-yellow-600" />;
      default:
        return null;
    }
  };

  const getStatusColor = (status: string) => {
    switch (status) {
      case "success":
        return "border-green-200 bg-green-50";
      case "error":
        return "border-red-200 bg-red-50";
      case "warning":
        return "border-yellow-200 bg-yellow-50";
      default:
        return "border-gray-200 bg-gray-50";
    }
  };

  const copyFixScript = () => {
    const script = `-- ŸÜÿ≥ÿÆ Ÿáÿ∞ÿß ÿßŸÑŸÉŸàÿØ Ÿàÿ™ÿ¥ÿ∫ŸäŸÑŸá ŸÅŸä Supabase SQL Editor
-- Ÿáÿ∞ÿß ÿ≥Ÿäÿ≠ŸÑ ŸÖÿ¥ŸÉŸÑÿ© ÿπÿØŸÖ ÿ∏ŸáŸàÿ± ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÅŸä ŸÉÿ¥ŸÅ ÿßŸÑÿ≠ÿ≥ÿßÿ®

CREATE TABLE IF NOT EXISTS sale_items (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    sale_id UUID NOT NULL,
    product_id UUID NOT NULL,
    product_name TEXT NOT NULL,
    quantity INTEGER NOT NULL CHECK (quantity > 0),
    unit_price DECIMAL(10,2) NOT NULL CHECK (unit_price >= 0),
    total_amount DECIMAL(10,2) NOT NULL CHECK (total_amount >= 0),
    profit_amount DECIMAL(10,2) DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL
);

-- ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿπŸÑÿßŸÇÿßÿ™
ALTER TABLE sale_items ADD CONSTRAINT sale_items_sale_id_fkey
FOREIGN KEY (sale_id) REFERENCES sales(id) ON DELETE CASCADE;

ALTER TABLE sale_items ADD CONSTRAINT sale_items_product_id_fkey
FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE;

-- ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÅŸáÿßÿ±ÿ≥
CREATE INDEX IF NOT EXISTS idx_sale_items_sale_id ON sale_items(sale_id);
CREATE INDEX IF NOT EXISTS idx_sale_items_product_id ON sale_items(product_id);

SELECT '‚úÖ ÿ™ŸÖ ÿ•ÿµŸÑÿßÿ≠ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™!' as message;`;

    navigator.clipboard.writeText(script);
    alert("ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿßŸÑÿ≥ŸÉÿ±Ÿäÿ®ÿ™! ÿßŸÑÿµŸÇŸá ŸÅŸä Supabase SQL Editor");
  };

  return (
    <Card className="w-full max-w-4xl mx-auto">
      <CardHeader>
        <CardTitle className="flex items-center gap-2">
          <Database className="h-5 w-5" />
          ÿ™ÿ¥ÿÆŸäÿµ ŸÖÿ¥ŸÉŸÑÿ© ŸÉÿ¥ŸÅ ÿßŸÑÿ≠ÿ≥ÿßÿ®
        </CardTitle>
        <CardDescription>
          ŸÅÿ≠ÿµ ÿ≥ÿ®ÿ® ÿπÿØŸÖ ÿ∏ŸáŸàÿ± ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÅŸä ŸÉÿ¥ŸÅ ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿπŸÖŸäŸÑ
        </CardDescription>
      </CardHeader>
      <CardContent className="space-y-4">
        {/* Overall Status */}
        <Alert
          className={
            overallStatus === "critical"
              ? "border-red-200 bg-red-50"
              : overallStatus === "issues"
                ? "border-yellow-200 bg-yellow-50"
                : "border-green-200 bg-green-50"
          }
        >
          <AlertDescription className="flex items-center gap-2">
            {overallStatus === "critical" ? (
              <XCircle className="h-4 w-4 text-red-600" />
            ) : overallStatus === "issues" ? (
              <AlertTriangle className="h-4 w-4 text-yellow-600" />
            ) : (
              <CheckCircle className="h-4 w-4 text-green-600" />
            )}
            <span className="font-semibold">
              {overallStatus === "critical"
                ? "üö® ŸÖÿ¥ÿßŸÉŸÑ ÿ≠ÿ±ÿ¨ÿ© ŸÖŸàÿ¨ŸàÿØÿ©"
                : overallStatus === "issues"
                  ? "‚ö†Ô∏è ÿ®ÿπÿ∂ ÿßŸÑŸÖÿ¥ÿßŸÉŸÑ ŸÖŸàÿ¨ŸàÿØÿ©"
                  : "‚úÖ ÿßŸÑŸÜÿ∏ÿßŸÖ ŸäÿπŸÖŸÑ ÿ®ÿ¥ŸÉŸÑ ÿµÿ≠Ÿäÿ≠"}
            </span>
          </AlertDescription>
        </Alert>

        {/* Refresh Button */}
        <div className="flex justify-between items-center">
          <Button
            onClick={runDiagnostic}
            disabled={loading}
            variant="outline"
            className="flex items-center gap-2"
          >
            <RefreshCw className={`h-4 w-4 ${loading ? "animate-spin" : ""}`} />
            {loading ? "ÿ¨ÿßÿ±Ÿä ÿßŸÑŸÅÿ≠ÿµ..." : "ÿ•ÿπÿßÿØÿ© ÿßŸÑŸÅÿ≠ÿµ"}
          </Button>

          {overallStatus === "critical" && (
            <div className="flex gap-2">
              <Button
                onClick={copyFixScript}
                variant="destructive"
                className="flex items-center gap-2"
              >
                <Copy className="h-4 w-4" />
                ŸÜÿ≥ÿÆ ŸÉŸàÿØ ÿßŸÑÿ•ÿµŸÑÿßÿ≠
              </Button>
              <Button
                onClick={() =>
                  window.open("https://supabase.com/dashboard", "_blank")
                }
                variant="outline"
                className="flex items-center gap-2"
              >
                <ExternalLink className="h-4 w-4" />
                ŸÅÿ™ÿ≠ Supabase
              </Button>
            </div>
          )}
        </div>

        {/* Diagnostic Results */}
        <div className="space-y-3">
          {results.map((result, index) => (
            <div
              key={index}
              className={`p-4 rounded-lg border ${getStatusColor(result.status)}`}
            >
              <div className="flex items-start gap-3">
                {getStatusIcon(result.status)}
                <div className="flex-1">
                  <div className="flex items-center gap-2 mb-1">
                    <span className="font-semibold text-gray-800">
                      {result.name}
                    </span>
                    <Badge
                      variant={
                        result.status === "success"
                          ? "secondary"
                          : result.status === "error"
                            ? "destructive"
                            : "outline"
                      }
                    >
                      {result.status === "success"
                        ? "ŸÜÿ¨ÿ≠"
                        : result.status === "error"
                          ? "ŸÅÿ¥ŸÑ"
                          : "ÿ™ÿ≠ÿ∞Ÿäÿ±"}
                    </Badge>
                  </div>
                  <p className="text-gray-700 mb-2">{result.message}</p>
                  {result.details && (
                    <p className="text-sm text-gray-600 bg-white/50 p-2 rounded">
                      {result.details}
                    </p>
                  )}
                </div>
              </div>
            </div>
          ))}
        </div>

        {/* Quick Fix Instructions */}
        {overallStatus === "critical" && (
          <Alert className="border-blue-200 bg-blue-50">
            <AlertDescription>
              <div className="space-y-3">
                <h4 className="font-semibold text-blue-800">
                  üîß ÿÆÿ∑Ÿàÿßÿ™ ÿßŸÑÿ•ÿµŸÑÿßÿ≠ ÿßŸÑÿ≥ÿ±Ÿäÿπ:
                </h4>
                <ol className="list-decimal list-inside space-y-1 text-blue-700 text-sm">
                  <li>ÿßÿ∂ÿ∫ÿ∑ "ŸÜÿ≥ÿÆ ŸÉŸàÿØ ÿßŸÑÿ•ÿµŸÑÿßÿ≠" ÿ£ÿπŸÑÿßŸá</li>
                  <li>ÿßŸÜÿ™ŸÇŸÑ ÿ•ŸÑŸâ Supabase Dashboard</li>
                  <li>ÿßŸÅÿ™ÿ≠ SQL Editor</li>
                  <li>ÿßŸÑÿµŸÇ ÿßŸÑŸÉŸàÿØ Ÿàÿßÿ∂ÿ∫ÿ∑ RUN</li>
                  <li>ÿßÿ±ÿ¨ÿπ ŸáŸÜÿß Ÿàÿßÿ∂ÿ∫ÿ∑ "ÿ•ÿπÿßÿØÿ© ÿßŸÑŸÅÿ≠ÿµ"</li>
                  <li>ÿ¨ÿ±ÿ® ÿ•ÿ∂ÿßŸÅÿ© ÿπŸÖŸÑŸäÿ© ÿ®Ÿäÿπ ÿ¨ÿØŸäÿØÿ©</li>
                </ol>
              </div>
            </AlertDescription>
          </Alert>
        )}
      </CardContent>
    </Card>
  );
};

export default DatabaseDiagnostic;
